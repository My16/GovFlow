{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}GovFlowApp{% endblock %}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        <link rel="stylesheet" href="{% static 'css/homepage.css' %}">

        <!-- Favicon / Logo -->
        <link rel="icon" href="{% static 'img/mharsmc.png' %}" type="image/png">
    </head>

    <body>

        <div class="sidebar" id="sidebar">
            <a href="{% url 'homepage' %}" class="logo-link">
                <div class="logo">
                    <img src="{% static 'img/mharsmc.png' %}" alt="icon">
                    <span>GovFlowApp</span>
                </div>
            </a>

            <hr class="separator">

            <ul class="menu">
                <li class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" data-tooltip="Dashboard">
                    <a href="{% url 'dashboard' %}">
                        <i class="bi bi-house icon"></i><span>Dashboard</span>
                    </a>
                </li>
                <li class="{% if request.resolver_match.url_name == 'all_documents' %}active{% endif %}" data-tooltip="All Documents">
                    <a href="{% url 'all_documents' %}">
                        <i class="bi bi-folder2-open icon"></i><span>All Documents</span>
                    </a>
                </li>
                <li class="" data-tooltip="Completed">
                    <a href="">
                        <i class="bi bi-check-circle icon"></i><span>Completed</span>
                    </a>
                </li>
                <li class="{% if request.resolver_match.url_name == 'new_document' %}active{% endif %}" data-tooltip="New Document">
                    <a href="{% url 'new_document' %}">
                        <i class="bi bi-file-earmark-plus icon"></i><span>New Document</span>
                    </a>
                </li>
                <li data-tooltip="Receive Document">
                    <a href="{% url 'receive_page' %}">
                        <i class="bi bi-qr-code-scan icon"></i><span>Receive Document</span>
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer">
                <button class="sidebar-arrow" id="desktopToggle">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            
            <header class="main-header">
                
                <button class="header-toggle-btn" id="headerToggle">
                    <i class="bi bi-list"></i>
                </button>

                <div class="search-bar-container">
                    <form method="GET" action="{{ request.path }}" class="search-bar">
                        <i class="bi bi-search"></i>
                        <input
                            type="text"
                            name="q"
                            value="{{ search_query }}"
                            placeholder="Search by tracking number, title, or sender..."
                        >
                    </form>
                </div>

                <div class="user-actions">

                    <!-- notification here -->
                    <div class="dropdown">
                        <button class="icon-btn position-relative" data-bs-toggle="dropdown">
                            <i class="bi bi-bell-fill"></i>
                            <span class="badge bg-danger rounded-pill notification-badge position-absolute" style="display:none;">
                                {% if notification_count %}{{ notification_count }}{% else %}0{% endif %}
                            </span>
                        </button>


                        <ul id="notification-list" class="dropdown-menu dropdown-menu-end shadow notification-dropdown" style="width:320px; padding:0;">
                            {% if notifications %}
                                {% for n in notifications %}
                                <li>
                                    <a class="dropdown-item small" href="{% url 'mark_notification_read' n.id %}">
                                        {{ n.message }}<br>
                                        <span class="text-muted small">{{ n.created_at|timesince }} ago</span>
                                    </a>
                                </li>
                                {% endfor %}
                            {% else %}
                                <li class="dropdown-item text-muted text-center">
                                    No new notifications
                                </li>
                            {% endif %}
                        </ul>
                    </div>




                    <div class="profile-section d-flex align-items-center gap-2" id="'profileToggle">
                        <div class="profile-avatar">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <span class="welcome-name">Welcome, {{ request.user.get_full_name }}</span>
                    </div>

                    <div class="profile-dropdown" id="profileDropdown">
                        <a href="{% url 'logout' %}" class="btn btn-outline-danger logout-btn">Logout</a>
                    </div>
                </div>


            </header>

            <div class="content-body">
                {% block content %}
                    
                {% endblock %}
            </div>
        </div>

        <!-- QR Scanner Modal -->
        <div class="modal fade" id="receiveModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content receive-modal shadow-lg rounded-2xl overflow-hidden border">

                    <!-- Header -->
                    <div class="modal-header d-flex justify-content-between align-items-center bg-success text-white border-0">
                        <h5 class="modal-title d-flex align-items-center gap-2">
                            <i class="bi bi-camera text-white"></i>
                            Scan Document QR
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>


                    <!-- Body -->
                   <div class="modal-body text-center d-flex flex-column justify-content-center align-items-center gap-2">

                        <!-- QR Scanner -->
                        <div id="qr-scanner" class="qr-scanner mx-auto"></div>

                        <p class="text-muted">Align the QR code within the frame</p>


                        <!-- OR Separator -->
                        <div class="d-flex align-items-center w-100">
                            <hr class="flex-grow-1 m-0">
                            <span class="mx-2 text-muted" style="line-height: 1;">OR</span>
                            <hr class="flex-grow-1 m-0">
                        </div>

                        <!-- manual button -->
                       <button type="button" class="btn btn-outline-success w-100 d-flex align-items-center justify-content-center gap-2" data-bs-toggle="modal" data-bs-target="#manualEntryModal" data-bs-dismiss="modal">
                            <i class="bi bi-keyboard"></i> Enter Tracking Number Manually
                        </button>
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer d-flex flex-column gap-2">
                        <p class="text-secondary text-center small mb-0">Make sure the QR code fits inside the frame.</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- Manual Tracking Entry Modal -->
        <div class="modal fade" id="manualEntryModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content receive-modal shadow-lg rounded-2xl overflow-hidden border">

                    <!-- Header -->
                    <div class="modal-header d-flex justify-content-between align-items-center bg-success text-white border-0">
                        <h5 class="modal-title fw-bold d-flex align-items-center gap-2">
                            <i class="bi bi-keyboard"></i>
                            Manual Entry
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Body -->
                    <div class="modal-body d-flex flex-column gap-3">
                        <form method="POST" action="{% url 'receive_document' %}">
                            {% csrf_token %}
                            <div>
                                <label for="manualTracking" class="form-label fw-bold">Enter Document Tracking Number</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="bi bi-search text-secondary"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0" 
                                        id="manualTracking" 
                                        placeholder="e.g. TRK-2025-00001" 
                                        name="tracking_id"
                                        style="text-transform: uppercase;">
                                </div>
                                <small class="form-text text-muted">Enter the tracking number exactly as it appears on the routing slip.</small>
                            </div>

                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-outline-success">Find &amp; Receive</button>
                            </div>
                        </form>
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer d-flex flex-column gap-1">
                        <p class="text-secondary text-center small mb-0">Ensure the tracking number is correct before submitting.</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- Toast container -->
        <div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
            {% for message in messages %}
            <div class="toast align-items-center text-bg-{{ message.tags|default:'primary' }} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        {{ message }}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Routing Slip Modal -->
        <div class="modal fade" id="routingSlipModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Document Routing Slip</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body p-0">
                    {% include "documents/partials/routing_slip.html" %}
                </div>

                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button onclick="printRoutingSlip()" class="btn btn-outline-success">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
                </div>
            </div>
        </div>



        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
        <script src="{% static 'js/homepage.js' %}"></script>

    </body>

</html>